<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <script src="./d3.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700,900" rel="stylesheet">
  <style>
    body {
      font-size: 14px;
      font-family: Lato, Arial, "Helvetica Neue", Helvetica, sans-serif;
      font-weight: bold;
      width: 800px;
      margin: auto;
      text-align: center;
    }

    h1 {
      font-size: 40px;
      color: gray;
    }
    
    .arc path {
      stroke: #fff;
    }
  </style>
</head>

<body>
  <h1>World Population by age</h1>
  <script>
  /*
      Here is the compact implementation of the json data. Ideally it should be stored in a json file and should be retrieved by d3.json
      #c2e699
      #78c679
      #31a354
      #006837
  */
  data = [{
    "nodeData": {
      "age": "<5",
      "population": 60,
      "color": "#c2e699"
    },
    "subData": [{
      "nodeData": {
        "age": "<5",
        "population": 60,
        "color": "#c2e699"
      },
      "subData": [{
        "nodeData": {
          "age": "<5",
          "population": 60,
          "color": "#c2e699"
        }
      }]
    }]
  }, {
    "nodeData": {
      "age": "5-35",
      "population": 100,
      "color": "#78c679"
    },
    "subData": [{
      "nodeData": {
        "age": "5-15",
        "population": 60,
        "color": "#78c679"
      },
      "subData": [{
        "nodeData": {
          "age": "5-10",
          "population": 30,
          "color": "#78c679"
        }
      }, {
        "nodeData": {
          "age": "10-15",
          "population": 30,
          "color": "#78c679"
        }
      }]
    }, {
      "nodeData": {
        "age": "15-35",
        "population": 40,
        "color": "#78c679"
      },
      "subData": [{
        "nodeData": {
          "age": "15-25",
          "population": 25,
          "color": "#78c679"
        }
      }, {
        "nodeData": {
          "age": "25-35",
          "population": 15,
          "color": "#78c679"
        }
      }]
    }]
  }, {
    "nodeData": {
      "age": "35-65",
      "population": 100,
      "color": "#31a354"
    },
    "subData": [{
      "nodeData": {
        "age": "35-50",
        "population": 75,
        "color": "#31a354"
      },
      "subData": [{
        "nodeData": {
          "age": "35-50",
          "population": 75,
          "color": "#31a354"
        }
      }]
    }, {
      "nodeData": {
        "age": "50-65",
        "population": 25,
        "color": "#31a354"
      },
      "subData": [{
        "nodeData": {
          "age": "50-65",
          "population": 25,
          "color": "#31a354"
        }
      }]
    }]
  }, {
    "nodeData": {
      "age": ">65",
      "population": 100,
      "color": "#006837"
    },
    "subData": [{
      "nodeData": {
        "age": "65-75",
        "population": 60,
        "color": "#006837"
      },
      "subData": [{
        "nodeData": {
          "age": "65-75",
          "population": 60,
          "color": "#006837"
        }
      }]
    }, {
      "nodeData": {
        "age": ">75",
        "population": 40,
        "color": "#006837"
      },
      "subData": [{
        "nodeData": {
          "age": ">75",
          "population": 40,
          "color": "#006837"
        }
      }]
    }]
  }]

  var width = 500,
    height = 500,
    maxRadius = Math.min(width, height) / 2;

  var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");


  var multiLevelData = [];
  var setMultiLevelData = function(data) {
    if (data == null)
      return;
    var level = data.length,
      counter = 0,
      index = 0,
      currentLevelData = [],
      queue = [];

      debugger;

    for (var i = 0; i < data.length; i++) {
      queue.push(data[i]);
    };
      debugger;

    while (!queue.length == 0) {
      var node = queue.shift();
      currentLevelData.push(node);
      level--;
      debugger;

      if (node.subData) {
        for (var i = 0; i < node.subData.length; i++) {
          queue.push(node.subData[i]);
          counter++;
        };
      debugger;

      }
      if (level == 0) {
        level = counter;
        counter = 0;
        multiLevelData.push(currentLevelData);
        currentLevelData = [];
      }
    }
  }

  var drawPieChart = function(_data, index) {
    var pie = d3.layout.pie()
      .sort(null)
      .value(function(d) {
        return d.nodeData.population;
      });
    var arc = d3.svg.arc()
      .outerRadius((index + 1) * pieWidth - 1)
      .innerRadius(index * pieWidth);

    var g = svg.selectAll(".arc" + index).data(pie(_data)).enter().append("g")
      .attr("class", "arc" + index);

    g.append("path").attr("d", arc)
      .style("fill", function(d) {
        return color(d.data.nodeData.color);
      });

    g.append("text").attr("transform", function(d) {
        return "translate(" + arc.centroid(d) + ")";
      })
      .attr("dy", ".35em").style("text-anchor", "middle")
      .text(function(d) {
        return d.data.nodeData.age;
      });
  }


  setMultiLevelData(data);

  var pieWidth = parseInt(maxRadius / multiLevelData.length) - multiLevelData.length;

  var color = d3.scale
    .ordinal()
    .range(["#c2e699", "#78c679", "#31a354", "#006837"]);

  for (var i = 0; i < multiLevelData.length; i++) {
    var _cData = multiLevelData[i];
    drawPieChart(_cData, i);
  }
  </script>
</body>

</html>
