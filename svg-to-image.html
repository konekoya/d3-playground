<!DOCTYPE html>
<html lang="en">

<head>
  <title>How to properly export SVG D3 visualization to PNG or JPEG</title>
  <meta charset="utf-8">
  <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
   <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
  <script src="https://d3js.org/d3.v3.min.js"></script>
 </head>

<body>
<div>
<button id='saveButton'>Export my D3 visualization to PNG</button>
</div>

<svg class="bar-chart" width="800" height="624.3776245117188" xlink="http://www.w3.org/1999/xlink"><g transform="translate(120, 30)"><g class="x-axis" transform="translate(0, 350)"><g class="tick" transform="translate(21.040462427745666,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">非金融性資產淨額</text></g><g class="tick" transform="translate(53.41040462427746,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">房地產</text></g><g class="tick" transform="translate(85.78034682080926,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">家庭生活設備</text></g><g class="tick" transform="translate(118.15028901734105,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">金融性資產淨值</text></g><g class="tick" transform="translate(150.52023121387285,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">國外金融性資產淨值</text></g><g class="tick" transform="translate(182.89017341040463,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">國內金融性資產淨值</text></g><g class="tick" transform="translate(215.26011560693644,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">國內金融性資產</text></g><g class="tick" transform="translate(247.63005780346825,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">現金與活期性存款</text></g><g class="tick" transform="translate(280.00000000000006,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">定期性存款及外匯存款</text></g><g class="tick" transform="translate(312.36994219653184,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">有價證券</text></g><g class="tick" transform="translate(344.7398843930636,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">人壽保險準備及退休基金準備</text></g><g class="tick" transform="translate(377.10982658959546,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">其他國內金融性資產</text></g><g class="tick" transform="translate(409.47976878612724,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">國內金融性負債</text></g><g class="tick" transform="translate(441.849710982659,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">貸款</text></g><g class="tick" transform="translate(474.21965317919086,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">其他國內金融性負債</text></g><g class="tick" transform="translate(506.58959537572264,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">淨值</text></g><g class="tick" transform="translate(538.9595375722544,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text dy=".71em" y="9" x="0" style="text-anchor: end; transform: rotate(-65deg) translate(-10px, -5px);">淨值(不含人壽保險及退休基金準備)</text></g><path class="domain" d="M0,6V0H560V6"></path></g><g class="x-label" transform="translate(280, 564.3776245117188)"><rect rx="10" ry="10" class="x-label-rect" width="44" height="25" x="-22" y="-16"></rect><text class="x-label-text" style="text-anchor: middle;">項目</text></g><g class="y-axis" transform="translate(0, 0)"><g class="tick" transform="translate(0,350)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">0.0</text></g><g class="tick" transform="translate(0,315)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">0.2</text></g><g class="tick" transform="translate(0,280)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">0.4</text></g><g class="tick" transform="translate(0,244.99999999999997)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">0.6</text></g><g class="tick" transform="translate(0,210)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">0.8</text></g><g class="tick" transform="translate(0,175)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">1.0</text></g><g class="tick" transform="translate(0,140)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">1.2</text></g><g class="tick" transform="translate(0,105.00000000000001)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">1.4</text></g><g class="tick" transform="translate(0,69.99999999999999)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">1.6</text></g><g class="tick" transform="translate(0,34.99999999999999)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">1.8</text></g><g class="tick" transform="translate(0,0)" style="opacity: 1;"><line x2="-6" y2="0"></line><text dy=".32em" x="-9" y="0" style="text-anchor: end;">2.0</text></g><path class="domain" d="M-6,0H0V350H-6"></path></g><g class="y-label" transform="translate(-45.671875, 175)"><rect rx="10" ry="10" class="y-label-rect" x="-17" y="-31" width="25" height="62"></rect><text class="y-label-text" transform="rotate(270)" x="0" y="0" style="text-anchor: middle;">Volume</text></g><rect class="bar-rect" width="29.132947976878615" height="175" x="6.47398843930636" y="175" style="fill: rgb(31, 119, 180);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="38.843930635838156" y="175" style="fill: rgb(174, 199, 232);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="71.21387283236994" y="175" style="fill: rgb(255, 127, 14);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="103.58381502890174" y="175" style="fill: rgb(255, 187, 120);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="135.95375722543355" y="175" style="fill: rgb(44, 160, 44);"></rect><rect class="bar-rect" width="29.132947976878615" height="350" x="168.32369942196533" y="0" style="fill: rgb(152, 223, 138);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="200.69364161849714" y="175" style="fill: rgb(214, 39, 40);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="233.06358381502895" y="175" style="fill: rgb(255, 152, 150);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="265.43352601156073" y="175" style="fill: rgb(148, 103, 189);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="297.8034682080925" y="175" style="fill: rgb(197, 176, 213);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="330.1734104046243" y="175" style="fill: rgb(140, 86, 75);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="362.54335260115613" y="175" style="fill: rgb(196, 156, 148);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="394.9132947976879" y="175" style="fill: rgb(227, 119, 194);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="427.2832369942197" y="175" style="fill: rgb(247, 182, 210);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="459.65317919075153" y="175" style="fill: rgb(127, 127, 127);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="492.0231213872833" y="175" style="fill: rgb(199, 199, 199);"></rect><rect class="bar-rect" width="29.132947976878615" height="175" x="524.3930635838151" y="175" style="fill: rgb(188, 189, 34);"></rect></g></svg>
</body>
<script type="text/javascript">
// Let's create a mock visualization
var width = 800, height = 624;
// var circleSizeMax = 15;
// var rMax = Math.min(width,height)/2 - circleSizeMax;

// var radius  = d3.scale.linear().range([0,rMax]);
// var angle   = d3.scale.linear().range([0,2*Math.PI]);
// var size  = d3.scale.linear().range([0,circleSizeMax]);
// var color   = d3.scale.ordinal().range(['#fcfb3c','#fcf900','#ff825a','#ffd2cb','#71d362','#ffd16f','#ff3d5d','#ff7218','#04b3f3','#bce5ac','#6e0215','#69D2E7','#A7DBDB','#E0E4CC','#F38630','#E94C6F','#542733','#5A6A62','#C6D5CD','#DB3340','#E8B71A','#F7EAC8','#1FDA9A','#588C73','#F2E394','#F2AE72','#D96459','#D0C91F','#85C4B9','#008BBA','#DF514C','#00C8F8','#59C4C5','#FFC33C','#FBE2B4','#5E412F','#FCEBB6','#78C0A8','#F07818','#DE4D4E','#DA4624','#DE593A','#FFD041','#B1EB00','#53BBF4','#FF85CB','#FF432E','#354458','#3A9AD9','#29ABA4','#E9E0D6','#4298B5','#ADC4CC','#92B06A','#E19D29','#BCCF02','#5BB12F','#73C5E1','#9B539C','#FFA200','#00A03E','#24A8AC','#0087CB','#260126','#59323C','#F2EEB3','#BFAF80','#BFF073','#0DC9F7','#7F7F7F','#F05B47','#3B3A35','#20457C','#5E3448','#FB6648','#E45F56','#A3D39C','#7ACCC8','#4AAAA5','#DC2742','#AFA577','#ABA918','#8BAD39','#F2671F','#C91B26','#9C0F5F','#60047A','#0F5959','#17A697','#638CA6','#8FD4D9','#83AA30','#1499D3','#4D6684','#3D3D3D','#333333','#424242','#00CCD6','#EFEFEF','#CCC51C','#FFE600','#F05A28','#B9006E','#F17D80','#737495','#68A8AD','#C4D4AF']);
// var x = function(d) { return radius( d.r ) * Math.cos( angle( d.angle ) ); };
// var y = function(d) { return radius( d.r ) * Math.sin( angle( d.angle ) ); };

// var svg = d3.select('body').append('svg')
//   .attr('width', width)
//   .attr('height',height);

// var chart = svg.append('g').attr('transform','translate('+[width/2,height/2]+')');

// var data = d3.range(150).map( function(d) { return {r: Math.random(), angle: Math.random(), size: Math.random() }; });

// chart.selectAll('cirle')
//   .data(data).enter()
//   .append('circle')
//   .attr('class','blendCircle')
//   .attr({
//     cx: x,
//     cy: y,
//     r: function(d) { return size(d.size); },
//     fill: function(d,i) { return color(i); }
//   });


// Set-up the export button
d3.select('#saveButton').on('click', function(){
  const svg = d3.select('svg');
  var svgString = getSVGString(svg.node());
  svgString2Image( svgString, 2*width, 2*height, save ); // passes Blob and filesize String to the callback

  function save( dataBlob, filesize ){
    saveAs( dataBlob, 'D3 vis exported to PNG.png' ); // FileSaver.js function
  }
});

// Below are the functions that handle actual exporting:
// getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
function getSVGString( svgNode ) {
  svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
  var cssStyleText = getCSSStyles( svgNode );
  appendCSS( cssStyleText, svgNode );

  var serializer = new XMLSerializer();
  var svgString = serializer.serializeToString(svgNode);
  svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
  svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

  return svgString;

  function getCSSStyles( parentElement ) {
    var selectorTextArr = [];

    // Add Parent element Id and Classes to the list
    selectorTextArr.push( '#'+parentElement.id );
    for (var c = 0; c < parentElement.classList.length; c++)
        if ( !contains('.'+parentElement.classList[c], selectorTextArr) )
          selectorTextArr.push( '.'+parentElement.classList[c] );

    // Add Children element Ids and Classes to the list
    var nodes = parentElement.getElementsByTagName("*");
    for (var i = 0; i < nodes.length; i++) {
      var id = nodes[i].id;
      if ( !contains('#'+id, selectorTextArr) )
        selectorTextArr.push( '#'+id );

      var classes = nodes[i].classList;
      for (var c = 0; c < classes.length; c++)
        if ( !contains('.'+classes[c], selectorTextArr) )
          selectorTextArr.push( '.'+classes[c] );
    }

    // Extract CSS Rules
    var extractedCSSText = "";
    for (var i = 0; i < document.styleSheets.length; i++) {
      var s = document.styleSheets[i];
      
      try {
          if(!s.cssRules) continue;
      } catch( e ) {
            if(e.name !== 'SecurityError') throw e; // for Firefox
            continue;
          }

      var cssRules = s.cssRules;
      for (var r = 0; r < cssRules.length; r++) {
        if ( contains( cssRules[r].selectorText, selectorTextArr ) )
          extractedCSSText += cssRules[r].cssText;
      }
    }
    

    return extractedCSSText;

    function contains(str,arr) {
      return arr.indexOf( str ) === -1 ? false : true;
    }

  }

  function appendCSS( cssText, element ) {
    var styleElement = document.createElement("style");
    styleElement.setAttribute("type","text/css"); 
    styleElement.innerHTML = cssText;
    var refNode = element.hasChildNodes() ? element.children[0] : null;
    element.insertBefore( styleElement, refNode );
  }
}


function svgString2Image( svgString, width, height, callback ) {

  var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL

  var canvas = document.createElement("canvas");
  var context = canvas.getContext("2d");

  canvas.width = width;
  canvas.height = height;

  var image = new Image();
  image.onload = function() {
    context.clearRect ( 0, 0, width, height );
    context.drawImage(image, 0, 0, width, height);

    canvas.toBlob( function(blob) {
      var filesize = Math.round( blob.length/1024 ) + ' KB';
      if ( callback ) callback( blob, filesize );
    });

    
  };

  image.src = imgsrc;
}

</script>
</html>